import os
from flask import Flask, render_template, request
from flask_socketio import SocketIO
from game_advanced import BlackjackGameAdvanced

app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get("SECRET_KEY","replace-this")
socketio = SocketIO(app, cors_allowed_origins="*")

game = BlackjackGameAdvanced()

@app.route("/")
def index():
    return render_template("index.html")

@socketio.on("join")
def handle_join(data):
    name = data.get("name","Player")
    bet = data.get("bet",10)
    player = game.add_player(name)
    player.bet = bet
    state = game.deal_initial()
    socketio.emit("game_state", state)

@socketio.on("hit")
def handle_hit(data):
    name = data.get("name")
    split = data.get("split",False)
    state = game.hit(name, split)
    socketio.emit("game_state", state)

@socketio.on("stand")
def handle_stand(data):
    name = data.get("name")
    split = data.get("split",False)
    state = game.stand(name, split)
    socketio.emit("game_state", state)

@socketio.on("split")
def handle_split(data):
    name = data.get("name")
    state = game.split(name)
    socketio.emit("game_state", state)

if __name__=="__main__":
    port = int(os.environ.get("PORT",5000))
    socketio.run(app, host="0.0.0.0", port=port)
